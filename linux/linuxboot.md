# ref 
- https://ttend.tistory.com/61
- https://treeroad.tistory.com/entry/ROM-BIOS-%EB%9E%80
- https://intgeek.tistory.com/5
- http://egloos.zum.com/light99/v/5134237

# 리눅스가 부팅될 때의 프로세스 정리

## 리눅스 부팅 과정 

1. power on

2. ROM BIOS에서 지정된 부트 드라이브로 부팅 시작

- ROM 이란?
일단 ROM(=Read Only Memory) 이란 말 그대로 읽기 전용 메모리이다. 메모리를 생각하면 보통 읽기와 쓰기가 전부 가능한 것으로 인식되어 진다. 하지만 ROM은 주로 저장된 메모리를 읽을 수만 있고 새로운 정보를 기억시킬 수 없는 메모리를 말한다.

우리 주변에 ROM이 들어간 예를 보면 쉽게 이해가 간다. 흔히 사용하는 CD를 CD-ROM에 넣고 실행한다. CD-ROM을 실행시키면 그 안에 있는 내용들을 읽기만하지 수정, 편집을 할 수 없다. 그래서 CD-ROM 이라 불린다는 점.  주로 ROM에는 윈도우 같은 운영체제를 가동하기 전에 컴퓨터의 각 구성요소를 점검하기 위한 기본 정보들이 들어있고, 모니터 키보드, 디스크 드라이브 등이 서로 어떻게 정보를 전달하고, 이용할 것인지를 제어하는 기본 입출력시스템. 즉, BIOS 정보가 들어있다. 이런 것들은 아예 컴퓨터가 만들어질 때 제조회사에서 미리 결정하여 입력하는 정보이므로 사용자가 임의로 바꾸는 일은 없는 셈이라고 한다.

- RAM 이란?

RAM(=Random Access Memory) 란 어느 위치에 저장된 데이터든지 접근 하는데 동일한 시간이 걸리는 메모리이다. 어디서든 동일한 시간이 걸리기 때문에 '랜덤(Random, 무작위)'이라는 명칭이 주어졌다고 한다. 참고로 하드 디스크, 플로프 디스크 등의 자기 디스크나 자기 테이프는 저장된 위치에 따라 접근하는 데 걸리는 시간이 다르다.

일반적으로 C언어는 데이터를 메모리에 올린다, 저장한다 라는 말들이 나오는데 여기서 말하는 메모리가 바로 램, 즉 '메인 메모리(Main Memory, 주기억장치)'를 의미한다. 이 메인 메모리는 전기적인 신호로 데이터를 저장하기 때문에 속도가 빠르다. 이 빠른 것이 장점이기 때문에 컴퓨터의 주기억 장치로 사용되는 것이다.

- BIOS

메모리, 디스크, 모니터와 같은 주변기기 사이의 정보 전송을 관장하는 일종의 프로그램이다. 즉, 컴퓨터의 하드웨어에 가장 근접되어 있는 함수들의 집합이라고 볼 수 있다. BIOS는 ROM에 들어 있기 때문에 흔히 ROM BIOS라고 부른다. 

컴퓨터 부팅신 ```<DEL>, <F1>, <F2>``` 등 키를 누르면 나오는 CMOS 셋업 프로그램과 주변기기 초기화, 자체 진단 루틴도 이 ROM-BIOS에 같이 포함되어있다. ROM에는 쓰기가 불가능 하므로 주변기기에 대한 정보를 저장하려면 쓰기를 할 수 있는 다른 공간이 필요하다. 정보를 저장할 수 있는 다른 공간이 바로 CMOS라는 것인데, CMOS 셋업은 BIOS에 포함되어 있는 프로그램으로 주변기기에 대한 정보를 저장하고 전원이 끊어져도 정보가 사라지지 않은 비휘발성 특성을 가지고 있다. 그리고 CMOS 셋업 프로그램을 이용해서 장착된 주변기기에 대한 정보를 알려주면 BIOS는 그것에 기초하여 하드웨어를 인식하고 제어할 수 있게 되는 것이다.

3. 부트 섹터 로드

- 부트로더가 나올때까지 과정

시스템 전원이 시작되면 시스템에 이상이 있는지 체크하고 이상이 없는 경우 BIOS에서 지정한 부팅 순서에 따라 해당 드라이브로 부팅이 이루어 진다.

해당 드라이브의 첫번재 섹터인 부트 섹터를 읽어들이는데 이른 마스터 부트 레코드(Master Boot Record)라고 부른다.

리눅스의 경우 GRUM가 MBR에 저장되어 있다. 이전에는 부트로더로 lilo가 기본적으로 사용되었지만 지금은 GRUB을 디폴트로 사용하고 있다.

4. GRUB 작동

- GRUB(Grand Unified Boot Loader)란? 

GRUB은 GNU에서 만든 부트로더로 LILO(Linux Loader) 보다 발전된 형태로 리눅스의 기본 부트로더로 쓰입니다.

- 부팅과정에서 grub의 역활

전원을 킴과 동시에 ROM-BIOS는 post(하드웨어 점검)을 실행하고, MBR영역에서 부트로더를 로딩한다.

Grub은 부팅메뉴를 선택받고, 선택된 커널을 로딩한다. 그리고 스와퍼(Swapper) 프로세스를 실행한다.

실행된 스와퍼(Swapper)는 앞단계에서 인식했던 각 장치들의 드라이브를 초기화 시킨 다음, init 프로세스를 실행 후 스와퍼(Swapper)는 종료된다.
(Swapper: PID 0) 종료 후 (init: PID 1) 실행됨. 모든 프로세스의 부모프로세스로 init 프로세스가 됨

init은 /etc/inittab 이라는 설정 파일을 읽어 실행한다. (설정된 (0부터 6까지) 부팅 레벨을 선택)

/etc/rc.d/rc.sysinit 스크립트 파일을 실행 (부팅레벨에 상관없이 꼭 한번씩 실행되는 파일)

선택된 부팅 레벨(N)에 따라서 /etc/rc.d/rcN.d/디렉토리의 스크립트를 순차적으로 실행한다. (부팅시 자동 실행하는 데몬)

시스템매직키 설정, 시스템 전원공급 설정, 가상터미널과 로그인창 실행

5. 커널 이미지 적재

부트로더에서 리눅스가 선택되면 커널 이미지(/boot/vmlinuz-버전)가 작동한다.

커널 이미지는 압출되어 있는 상태이므로 swapper라는 프로그램에 의해 압축이 풀어지고, 메모리, 디스크 등 여러 하드웨어들을 체크하여 이에 대한 정보를 화면에 보여준다.

화면으로 출력되는 하드웨어 정보를 부팅 후 다시 보고 싶다면 로그인 후 다음의 명령어를 이용한다.

```
$ dmesg | more
$ cat /var/log/dmesg
```

6. 파일 시스템 마운트

커널은 루트 파일시스템을 마운트하는데, 이때 부트로더의 설정파일(/boot/grub/menu.lst)에 있는 root= 옵션으로 명시된파티션을 루트 파일 시스템으로 마운트 시킨다.

이때 루트 파티션이 잘못 지정되어 있거나, 루트 파티션이 변경되었음에도 이 정보가 갱신되지 않았을 때 커널에서 파일 시스템 마운트 과정이 실패하고 결국 패닉에러를 보이며 부팅이 실패한다.

7. 시스템 초기화 프로그램(init) 작동

루트 파일 시스템이 마운트 된 후 제일 먼저 시작되는 프로세스인 init는 프로세스 번호 1번을 갖는다.

시스템은init 프로세스에 의해 초기화가 이루어진다. 즉 로그인 프로프트가나오기 전까지 파일 시스템 점검, 서비스 프로세스 관리, 가상 콘솔 접속 관리, 실행레벨 관리 등 사용자의 리눅스 사용환경을 위한 초기 작업을 실행한다.

init 프로세스가 실행될때 제일 먼저 읽어들이는 파일이 /etc/inittab 파일이며, inittab 파일의 설정에 따라 프로세스들을 실행시킨다.

커널의 로딩 과정을 살펴보면 커널이 로드되고 나면 메모리, 프로세스, I/O 등 여러 하드웨어를 초기화하고 설정한다.

압축된 initramfs 이미지를 메모리의 미리 정해진 위치(SD 카드, eMMC 등)로 부터 읽어서, /sysroot/에 직접 풀고, 모든 필요한 드라이버를 로드함.

이는 LVM이나 소프트웨어 RAID와 같은 파일 시스템과 관련된 가상 장치를 초기화 함.

그 후, initramfs 프로세스를 마무리하고, 디스크 이미지가 차지했던 메모리를 모두 해제함.

그 위 커널은 루트 장치를 생성하여 읽기 전용으로 루트 파티션을 마운트하고 사용되지 않는 메모리를 해제함.

이 시점에서, 커널은 메모리에 로드되어 작동가능하게 되지만, 시스템에 입력을 허용하는 사용자 응용 프로그램이 존재하지 않아 이러한 시스템을 사용하여 할 수 잇는 작업은 많지 않음

사용자 환경을 설정하기 위해, 커널은 /sbin/init 프로그램을 실행 함

8. 로그인
